<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>控制台 - 超级管理员平台</title>
    <link rel="stylesheet" href="css/styles.css">
</head>
<body>
    <!-- 头部导航 -->
    <header class="header">
        <div class="header-title">控制台</div>
        <button id="logoutBtn" class="btn btn-secondary">退出登录</button>
    </header>

    <!-- 主要内容 -->
    <main class="container">
        <!-- 统计卡片 -->
        <div class="dashboard-stats">
            <div class="stat-card">
                <div class="stat-label">总用户数</div>
                <div id="totalUsers" class="stat-value">--</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">总门店数</div>
                <div id="totalStores" class="stat-value">--</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">活跃门店</div>
                <div id="activeStores" class="stat-value">--</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">今日新增</div>
                <div id="todayNew" class="stat-value">--</div>
            </div>
        </div>

        <!-- 功能导航 -->
        <ul class="nav-list">
            <li>
                <a href="users.html" class="nav-item">
                    <div class="nav-item-title">用户管理</div>
                    <div class="nav-item-icon">→</div>
                </a>
            </li>
            <li>
                <a href="usage.html" class="nav-item">
                    <div class="nav-item-title">应用使用情况</div>
                    <div class="nav-item-icon">→</div>
                </a>
            </li>
            <li>
                <a href="activities.html" class="nav-item">
                    <div class="nav-item-title">最近动态</div>
                    <div class="nav-item-icon">→</div>
                </a>
            </li>
        </ul>
    </main>

    <script type="module">
        import { auth } from './js/auth.js';
        import { logout, getAppUsageStats } from './js/api.js';
        import { showToast } from './js/utils.js';

        // 检查登录状态
        if (!auth.isLoggedIn() || !auth.isSuperAdmin()) {
            window.location.href = 'index.html';
        }

        // 获取当前用户信息
        const currentUser = auth.getCurrentUser();
        if (!currentUser) {
            auth.clearAuth();
            window.location.href = 'index.html';
        }

        // 页面加载时获取统计数据
        document.addEventListener('DOMContentLoaded', async () => {
            await loadUsageStats();

            // 退出登录按钮
            document.getElementById('logoutBtn').addEventListener('click', async () => {
                if (confirm('确定要退出登录吗？')) {
                    const result = await logout();
                    if (result.success) {
                        showToast('已退出登录', 'info');
                        setTimeout(() => {
                            window.location.href = 'index.html';
                        }, 1000);
                    } else {
                        showToast('退出失败，请重试', 'error');
                    }
                }
            });
        });

        // 加载使用统计数据
        async function loadUsageStats() {
            try {
                const result = await getAppUsageStats();
                if (result.success && result.data) {
                    const stats = result.data;
                    // 更新统计数字
                    document.getElementById('totalUsers').textContent = stats.total_users || 0;
                    document.getElementById('totalStores').textContent = stats.total_stores || 0;
                    document.getElementById('activeStores').textContent = stats.active_stores || 0;
                    document.getElementById('todayNew').textContent = stats.today_new_stores || 0;
                } else {
                    showToast(result.message || '获取统计数据失败', 'error');
                }
            } catch (error) {
                showToast('获取统计数据异常', 'error');
            }
        }
    </script>
</body>
</html>